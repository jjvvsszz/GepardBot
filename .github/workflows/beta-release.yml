name: Beta Release

on:
  push:
    branches:
      - beta

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Beta Version
        id: calc_version
        run: |
          echo "üîÑ Buscando tags..."
          git fetch --tags
          
          # 1. Encontra a √∫ltima tag EST√ÅVEL na branch master (ignora betas)
          # Ex: Encontra v0.3.0 mesmo que exista v0.3.1-beta.5
          LATEST_STABLE=$(git describe --tags --abbrev=0 --match "v[0-9]*.[0-9]*.[0-9]*" --exclude "*-*" origin/master 2>/dev/null || echo "v0.0.0")
          echo "‚úÖ √öltima vers√£o est√°vel: $LATEST_STABLE"

          # 2. Analisa commits entre a Est√°vel e o HEAD atual para decidir o BUMP (Major, Minor ou Patch)
          LOGS=$(git log "${LATEST_STABLE}..HEAD" --pretty=format:"%s")
          
          BUMP="patch"
          if echo "$LOGS" | grep -q "BREAKING CHANGE"; then
            BUMP="major"
            echo "‚ö†Ô∏è Detectado BREAKING CHANGE. Bump: MAJOR"
          elif echo "$LOGS" | grep -q "^feat"; then
            BUMP="minor"
            echo "‚ú® Detectado feature. Bump: MINOR"
          else
            echo "üêõ Apenas fixes/outros. Bump: PATCH"
          fi

          # 3. Calcula a Base da Pr√≥xima Vers√£o (Ex: de v0.3.0 para v0.3.1 ou v0.4.0)
          VERSION=${LATEST_STABLE#v}
          IFS='.' read -r -a PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          if [ "$BUMP" == "major" ]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
          elif [ "$BUMP" == "minor" ]; then
            MINOR=$((MINOR + 1)); PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          NEXT_BASE="v$MAJOR.$MINOR.$PATCH"
          echo "üéØ Vers√£o Alvo Base: $NEXT_BASE"

          # 4. Verifica se j√° existem betas para essa base e incrementa o sufixo
          # Procura tags que comecem com v0.3.1-beta.
          LAST_BETA=$(git tag -l "${NEXT_BASE}-beta.*" | sort -V | tail -n 1)

          if [ -z "$LAST_BETA" ]; then
            NEW_TAG="${NEXT_BASE}-beta.1"
          else
            # Extrai o n√∫mero depois de 'beta.' e soma 1
            LAST_NUM=$(echo "$LAST_BETA" | awk -F'beta.' '{print $2}')
            NEXT_NUM=$((LAST_NUM + 1))
            NEW_TAG="${NEXT_BASE}-beta.$NEXT_NUM"
          fi

          echo "üöÄ Nova Tag Beta Calculada: $NEW_TAG"
          
          # Exporta para os pr√≥ximos steps
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "new_version=${NEW_TAG#v}" >> $GITHUB_OUTPUT

      - name: Push Beta Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.calc_version.outputs.new_tag }}
          git push origin ${{ steps.calc_version.outputs.new_tag }}

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Update Gradle Version
        run: |
          sed -i 's/version = .*/version = "${{ steps.calc_version.outputs.new_version }}"/' build.gradle.kts

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Remove Plain JAR
        run: rm build/libs/*-plain.jar || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.calc_version.outputs.new_tag }}
          name: Beta ${{ steps.calc_version.outputs.new_version }}
          generate_release_notes: true
          body: |
            ## üöß Vers√£o Beta Autom√°tica
            **Base:** ${{ steps.calc_version.outputs.new_tag }}
            
            Esta √© uma vers√£o de pr√©-lan√ßamento. Use com cuidado.
          draft: false
          prerelease: true
          files: |
            build/libs/*.jar
            pterodactylEgg/egg-gepard-bot.json